/* uglified */
"use strict";var e=this&&this.__awaiter||function(e,r,t,s){return new(t||(t=Promise))((function(o,a){function i(e){try{n(s.next(e))}catch(e){a(e)}}function c(e){try{n(s.throw(e))}catch(e){a(e)}}function n(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(i,c)}n((s=s.apply(e,r||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const t=require("./child"),s=require("./worker"),o=require("../utils/ps"),a=require("./error"),i=r(require("../utils/logger")),c=r(require("./emitter")),n=r(require("./logger"));let d,u;const l=n.default(i.default,"torrent"),_=e=>{const r=e&&"string"==typeof e.message&&e.message?e.message:"Daemon failed";l.error("on_child_error",r),u&&u.cleanup(),t.soft_kill_child(),c.default.emit("error",{code:a.ERROR_CHILD_ERROR,message:e&&"string"==typeof e.message&&e.message?e.message:"Daemon failed"})},m=e=>{const r=`Daemon closed with code ${e}`;l.error("on_child_close",r),u&&u.cleanup(),t.soft_kill_child(),c.default.emit("error",{message:r,code:a.ERROR_CHILD_CLOSE})},p=()=>{try{l.info("stop"),u&&u.cleanup(),clearTimeout(d),d=setTimeout((()=>t.soft_kill_child()),1e4)}catch(e){const r=a.wrap_error(e);c.default.emit("error",{message:r.message,code:r.code})}},f=e=>{u&&(e?u.push_commands({type:"set_params",data:{max_connections:0,max_uploads:0,upload_limit:0,download_limit:0}}):u.push_commands({type:"clear_params"}))},h=e=>{u&&(e?u.push_commands({type:"pause"}):u.push_commands({type:"resume"}))},g=(e,r)=>{u&&(e&&r?u.push_commands({type:"set_proxy_params",data:r}):u.push_commands({type:"clear_proxy_params"}))},y=r=>{e(void 0,void 0,void 0,(function*(){try{clearTimeout(d),l.info("start",r),r.game_path&&(yield o.ps.AddMpPreferenceExclusionPath(r.game_path));const e=yield t.get_child({error:_.bind(this),close:m.bind(this)});u&&u.cleanup(),u=s.create_worker(e,{logger:l,preload:r.preload}),f(!!r.quiet),h(!!r.paused),g(!!r.proxied,r.proxy_params),yield u.start(r)}catch(e){if("ignoreplease"===e.message)return;const r=e;("string"==typeof r.message&&r.message.includes("exceeded")&&r.code===a.ERROR_UNKNOWN||r.code===a.ERROR_NOT_ALIVE)&&t.soft_kill_child(),u&&!u.is_destroyed()&&u.cleanup();const s=a.wrap_error(r);c.default.emit("error",{message:s.message,code:s.code})}}))},R=(e,r,t)=>{if(u)return u.subscribe(e,r,t)},x=e=>{u&&u.unsubscribe(e)},b={start:y,stop:p,subscribe:R,unsubscribe:x,set_quiet_mode:f,set_paused_mode:h,set_proxied_mode:g};exports.default=b;